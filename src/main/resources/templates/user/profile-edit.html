<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chỉnh sửa thông tin cá nhân</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/user/layout.css">
    <style>
        .edit-profile-card { max-width: 800px; margin: 40px auto; border-radius: 18px; box-shadow: 0 2px 16px rgba(35,50,107,0.10); background: #fff; }
        .edit-profile-header { border-bottom: 1px solid #e5e5e5; padding: 24px 32px 16px 32px; border-top-left-radius: 18px; border-top-right-radius: 18px; background: #fff; }
        .edit-profile-avatar { width: 112px; height: 112px; border: 6px solid #fff; box-shadow: 0 4px 16px rgba(0,0,0,0.10); position: absolute; left: 40px; top: 140px; background: #fff; }
        .avatar-upload-btn { position: absolute; left: 140px; top: 210px; }
        .edit-profile-form { padding: 32px 32px 24px 32px; }
        .form-label { font-weight: 600; }
        .form-control[readonly], .form-control[disabled] { background: #f2f4f8; }
        .btn-warning { background: #ff7a00; color: #fff; border: none; }
        .btn-warning:hover { background: #ff9900; color: #fff; }
        .btn-outline-warning { border: 1.5px solid #ff7a00; color: #ff7a00; }
        .btn-outline-warning:hover { background: #ff7a00; color: #fff; }
        @media (max-width: 991.98px) {
            .edit-profile-card { margin: 0; border-radius: 0;}
            .edit-profile-header { border-radius: 0; padding: 16px;}
            .edit-profile-form { padding: 16px;}
            .edit-profile-avatar { left: 50%; transform: translateX(-50%); top: 120px;}
            .avatar-upload-btn { left: 60%; top: 210px;}
        }

        .profile-cover {
            object-fit: cover;
            width: 100%;
            height: 100%;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
        }

        .profile-avatar {
            width: 112px;
            height: 112px;
            border-radius: 50%;
            object-fit: cover;
            border: 6px solid #fff;
            box-shadow: 0 4px 16px rgba(0,0,0,0.10);
            background: #fff;
        }

        /* Đảm bảo ảnh preview không làm vỡ bố cục */
        #avatarPreview, #coverPreview {
            object-fit: cover;
            display: block;
        }
    </style>
</head>
<body>
<!-- HEADER ĐỒNG BỘ -->
<div th:replace="~{fragments/user/header :: header}"></div>
<div class="container" >
    <!-- Card cover + avatar + nút -->
    <div class="card profile-card bg-white my-4 position-relative" style="border-radius: 18px; box-shadow: 0 2px 16px rgba(35,50,107,0.10);">
        <div class="position-relative" style="height:240px;">
            <img th:src="${user.userProfile?.cover != null ? user.userProfile.cover : 'https://media.vietnamplus.vn/images/ff19e4aafab8485e8307470102cc768913111b4eeeb06dd8393e71d67982f6bf02764b1fba7ad23425af24c332b1cd09/dai-hoc-phenikaa.jpg'}" class="profile-cover w-100 h-100" style="object-fit:cover; border-top-left-radius:18px; border-top-right-radius:18px;" id="coverPreview">
            <button type="button" class="btn btn-light border position-absolute d-flex align-items-center gap-2 px-3 py-1" style="top:20px; right:120px; border-radius:10px; font-weight:500; font-size:0.98rem; box-shadow:0 2px 8px rgba(0,0,0,0.08);" onclick="document.getElementById('coverInput').click()">
                <i class="fa fa-upload"></i> Upload
            </button>
            <button type="button" class="btn btn-light border position-absolute d-flex align-items-center gap-2 px-3 py-1" style="top:20px; right:20px; border-radius:10px; font-weight:500; font-size:0.98rem; box-shadow:0 2px 8px rgba(0,0,0,0.08);" onclick="resetCoverDefault()">
                <i class="fa fa-undo"></i> Reset
            </button>
            <input type="file" id="coverInput" name="cover" accept="image/*" class="d-none" onchange="previewCover(event)">
            <!-- Avatar nổi -->
            <div class="position-absolute" style="left:40px; bottom:-56px;">
                <img th:src="${user.userProfile?.avatar != null ? user.userProfile.avatar : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IGhlaWdodD0iMTI4IHZpZXdCb3g9IjAgMCAxMjggMTI4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgZmlsbD0iI0Y1RjVGNSIvPgo8cGF0aCBkPSJNNjQgNjRDNzguNTQxMiA2NCA5MCA1Mi41NDEyIDkwIDM4QzkwIDIzLjQ1ODggNzguNTQxMiAxMiA2NCAxMkM0OS40NTg4IDEyIDM4IDIzLjQ1ODggMzggMzhDMzggNTIuNTQxMiA0OS40NTg4IDY0IDY0IDY0WiIgZmlsbD0iI0Q5RDlEOSIvPgo8cGF0aCBkPSJNNjQgNzJDNjQgNzIgOTAgNjQuMDg1MSA5MCA1NEgzNEMzNCA2NC4wODUxIDQxLjkxNDkgNzIgNjQgNzJaIiBmaWxsPSIjRDVENUQ1Ii8+Cjwvc3ZnPgo='}" class="profile-avatar rounded-circle" id="avatarPreview">
                <button type="button" class="btn btn-light border position-absolute d-flex align-items-center gap-2 px-2 py-1" style="bottom:8px; left:90px; border-radius:10px; font-size:0.95rem; box-shadow:0 2px 8px rgba(0,0,0,0.08);" onclick="document.getElementById('avatarInput').click()">
                    <i class="fa fa-camera"></i>
                </button>
                <input type="file" id="avatarInput" name="avatar" accept="image/*" class="d-none" onchange="previewAvatar(event)">
            </div>
        </div>
        <!-- Form chỉnh sửa thông tin cá nhân -->
        <form th:action="@{/profile/update}" th:object="${user}" method="POST" class="edit-profile-form px-5 pb-4 pt-5">

            <h4 class="fw-bold mb-4 mt-2" style="color:#22336b;">Chỉnh sửa thông tin cá nhân</h4>
            <div class="row g-3">
                <input type="hidden" th:field="*{id}" />

                <input type="hidden" id="avatarUrlInput" name="userProfile.avatar"
                           th:value="${user.userProfile?.avatar}">

                <input type="hidden" id="coverUrlInput" name="userProfile.cover"
                           th:value="${user.userProfile?.cover}">

                <div class="col-md-6">
                    <label class="form-label">Tên đăng nhập</label>
                    <input type="text" class="form-control" th:field="*{username}">
                </div>
                <span th:if="${#fields.hasErrors('username')}" class="text-danger small" th:errors="*{username}"></span>

                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" th:field="*{email}" required>
                </div>
                <span th:if="${#fields.hasErrors('email')}" class="text-danger small" th:errors="*{email}"></span>

                <div class="col-md-6">
                    <label class="form-label">Họ</label>
                    <input type="text" class="form-control" th:field="*{firstName}">
                </div>
                <span th:if="${#fields.hasErrors('firstName')}" class="text-danger small" th:errors="*{firstName}"></span>

                <div class="col-md-6">
                    <label class="form-label">Tên</label>
                    <input type="text" class="form-control" th:field="*{lastName}">
                </div>
                <span th:if="${#fields.hasErrors('lastName')}" class="text-danger small" th:errors="*{lastName}"></span>

                <div class="col-md-6">
                    <label class="form-label">Số điện thoại</label>
                    <input type="text" class="form-control" th:field="*{phone}">
                </div>
                <span th:if="${#fields.hasErrors('phone')}" class="text-danger small" th:errors="*{phone}"></span>

                <div class="col-md-6">
                    <label class="form-label">Ngày sinh</label>
                    <input type="date" class="form-control" th:field="*{birthDate}">
                </div>
                <span th:if="${#fields.hasErrors('birthDate')}" class="text-danger small" th:errors="*{birthDate}"></span>

                <div class="col-md-6">
                    <label class="form-label">Giới tính</label>
                    <select class="form-select" th:field="*{gender}">
                        <option value="">Chọn giới tính</option>
                        <option value="NAM">Nam</option>
                        <option value="NU">Nữ</option>
                        <option value="KHAC">Khác</option>
                    </select>
                </div>
                <span th:if="${#fields.hasErrors('gender')}" class="text-danger small" th:errors="*{gender}"></span>

                <div class="col-md-6">
                    <label class="form-label">Địa chỉ</label>
                    <input type="text" class="form-control" th:field="*{address}">
                </div>
                <span th:if="${#fields.hasErrors('address')}" class="text-danger small" th:errors="*{address}"></span>

                <div class="col-12">
                    <label class="form-label">Mô tả bản thân</label>
                    <textarea class="form-control" th:field="*{profileInfo}" rows="2"></textarea>
                </div>
                <span th:if="${#fields.hasErrors('profileInfo')}" class="text-danger small" th:errors="*{profileInfo}"></span>

                <div class="col-12">
                    <label class="form-label">Bio (giới thiệu ngắn)</label>
                    <textarea class="form-control" th:field="*{userProfile.bio}" rows="2"></textarea>
                </div>
                <span th:if="${#fields.hasErrors('userProfile.bio')}" class="text-danger small" th:errors="*{userProfile.bio}"></span>

                <div class="col-12">
                    <label class="form-label">Liên kết trang cá nhân</label>
                    <input type="text" class="form-control" th:value="@{'/profile/' + ${user.username}}" readonly style="background:#f2f4f8;">
                    <div class="mt-1">
                        <a th:href="@{'/profile/' + ${user.username}}" target="_blank" class="small text-primary">
                            Xem trang cá nhân
                        </a>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-4">
                <a th:href="@{'/profile/' + ${user.username}}" class="btn btn-outline-secondary">Hủy</a>
                <button type="reset" class="btn btn-outline-warning">Đặt lại</button>
                <button type="submit" class="btn btn-warning fw-bold"><i class="fa fa-save me-1"></i>Lưu thay đổi</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/jwt-utils.js"></script>
<script src="/js/logout.js"></script>

<script>
    const cloudName = "dsqkymrkm";

    // Sử dụng preset riêng cho từng loại
    const uploadPresets = {
        avatar: "forumikaa-avatar",
        cover: "forumikaa-cover"
    };

    // Upload function với preset riêng
    function uploadToCloudinary(file, folder, callback) {
        const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPresets[folder]);

        fetch(url, {
            method: "POST",
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.secure_url) {
                    callback(data.secure_url);
                } else {
                    throw new Error(data.error?.message || "Upload failed");
                }
            })
            .catch(err => {
                console.error("Upload error:", err);
                alert("Lỗi upload ảnh: " + err.message);
            });
    }

    // Avatar upload
    document.getElementById("avatarInput").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert("Vui lòng chọn file ảnh");
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert("File ảnh không được vượt quá 5MB");
                return;
            }

            uploadToCloudinary(file, "avatar", function (url) {
                document.getElementById("avatarPreview").src = url;
                document.getElementById("avatarUrlInput").value = url;
            });
        }
    });

    // Cover upload
    document.getElementById("coverInput").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert("Vui lòng chọn file ảnh");
                return;
            }

            // Validate file size (max 10MB for cover)
            if (file.size > 10 * 1024 * 1024) {
                alert("File ảnh cover không được vượt quá 10MB");
                return;
            }

            uploadToCloudinary(file, "cover", function (url) {
                document.getElementById("coverPreview").src = url;
                document.getElementById("coverUrlInput").value = url;
            });
        }
    });

    function resetCoverDefault() {
        const defaultUrl = 'https://media.vietnamplus.vn/images/ff19e4aafab8485e8307470102cc768913111b4eeeb06dd8393e71d67982f6bf02764b1fba7ad23425af24c332b1cd09/dai-hoc-phenikaa.jpg';
        document.getElementById('coverPreview').src = defaultUrl;
        document.getElementById('coverInput').value = '';
        document.getElementById('coverUrlInput').value = defaultUrl;
    }
</script>


</body>
</html> 