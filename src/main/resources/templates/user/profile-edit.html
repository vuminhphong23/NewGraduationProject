<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chỉnh sửa thông tin cá nhân</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/user/layout.css">
    <style>
        .edit-profile-card { max-width: 800px; margin: 40px auto; border-radius: 18px; box-shadow: 0 2px 16px rgba(35,50,107,0.10); background: #fff; }
        .edit-profile-header { border-bottom: 1px solid #e5e5e5; padding: 24px 32px 16px 32px; border-top-left-radius: 18px; border-top-right-radius: 18px; background: #fff; }
        .edit-profile-avatar { width: 112px; height: 112px; border: 6px solid #fff; box-shadow: 0 4px 16px rgba(0,0,0,0.10); position: absolute; left: 40px; top: 140px; background: #fff; }
        .avatar-upload-btn { position: absolute; left: 140px; top: 210px; }
        .edit-profile-form { padding: 32px 32px 24px 32px; }
        .form-label { font-weight: 600; }
        .form-control[readonly], .form-control[disabled] { background: #f2f4f8; }
        .btn-warning { background: #ff7a00; color: #fff; border: none; }
        .btn-warning:hover { background: #ff9900; color: #fff; }
        .btn-outline-warning { border: 1.5px solid #ff7a00; color: #ff7a00; }
        .btn-outline-warning:hover { background: #ff7a00; color: #fff; }
        @media (max-width: 991.98px) {
            .edit-profile-card { margin: 0; border-radius: 0;}
            .edit-profile-header { border-radius: 0; padding: 16px;}
            .edit-profile-form { padding: 16px;}
            .edit-profile-avatar { left: 50%; transform: translateX(-50%); top: 120px;}
            .avatar-upload-btn { left: 60%; top: 210px;}
        }

        .profile-cover {
            object-fit: cover;
            width: 100%;
            height: 100%;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
        }

        .profile-avatar {
            width: 112px;
            height: 112px;
            border-radius: 50%;
            object-fit: cover;
            border: 6px solid #fff;
            box-shadow: 0 4px 16px rgba(0,0,0,0.10);
            background: #fff;
        }

        /* Đảm bảo ảnh preview không làm vỡ bố cục */
        #avatarPreview, #coverPreview {
            object-fit: cover;
            display: block;
        }
    </style>
</head>
<body>
<!-- HEADER ĐỒNG BỘ -->
<div th:replace="~{fragments/user/header :: header}"></div>
<div class="container" >
    <!-- Card cover + avatar + nút -->
    <div class="card profile-card bg-white my-4 position-relative" style="border-radius: 18px; box-shadow: 0 2px 16px rgba(35,50,107,0.10);">
        <div class="position-relative" style="height:240px;">
            <img th:src="${user.userProfile?.cover != null ? user.userProfile.cover : 'https://media.vietnamplus.vn/images/ff19e4aafab8485e8307470102cc768913111b4eeeb06dd8393e71d67982f6bf02764b1fba7ad23425af24c332b1cd09/dai-hoc-phenikaa.jpg'}" class="profile-cover w-100 h-100" style="object-fit:cover; border-top-left-radius:18px; border-top-right-radius:18px;" id="coverPreview">
            <button type="button" class="btn btn-light border position-absolute d-flex align-items-center gap-2 px-3 py-1" style="top:20px; right:120px; border-radius:10px; font-weight:500; font-size:0.98rem; box-shadow:0 2px 8px rgba(0,0,0,0.08);" onclick="document.getElementById('coverInput').click()">
                <i class="fa fa-upload"></i> Upload
            </button>
            <button type="button" class="btn btn-light border position-absolute d-flex align-items-center gap-2 px-3 py-1" style="top:20px; right:20px; border-radius:10px; font-weight:500; font-size:0.98rem; box-shadow:0 2px 8px rgba(0,0,0,0.08);" onclick="resetCoverDefault()">
                <i class="fa fa-undo"></i> Reset
            </button>
            <input type="file" id="coverInput" name="cover" accept="image/*" class="d-none">
            <!-- Avatar nổi -->
            <div class="position-absolute" style="left:40px; bottom:-56px;">
                <img th:src="${user.userProfile?.avatar != null ? user.userProfile.avatar : 'https://cdn.pixabay.com/photo/2023/02/18/11/00/icon-7797704_640.png'}" class="profile-avatar rounded-circle" id="avatarPreview">
                <button type="button" class="btn btn-light border position-absolute d-flex align-items-center gap-2 px-2 py-1" style="bottom:8px; left:90px; border-radius:10px; font-size:0.95rem; box-shadow:0 2px 8px rgba(0,0,0,0.08);" onclick="document.getElementById('avatarInput').click()">
                    <i class="fa fa-camera"></i>
                </button>
                <input type="file" id="avatarInput" name="avatar" accept="image/*" class="d-none">
            </div>
        </div>
        <!-- Form chỉnh sửa thông tin cá nhân -->
        <form id="profileForm" class="edit-profile-form px-5 pb-4 pt-5">

            <h4 class="fw-bold mb-4 mt-2" style="color:#22336b;">Chỉnh sửa thông tin cá nhân</h4>
            <div class="row g-3">
                <input type="hidden" id="avatarUrlInput" th:value="${user.userProfile?.avatar}">
                <input type="hidden" id="coverUrlInput" th:value="${user.userProfile?.cover}">

                <div class="col-md-6">
                    <label class="form-label">Tên đăng nhập</label>
                    <input type="text" id="username" class="form-control" th:value="${user.username}" readonly style="background:#f2f4f8;">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" id="email" class="form-control" th:value="${user.email}" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Họ</label>
                    <input type="text" id="firstName" class="form-control" th:value="${user.firstName}">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Tên</label>
                    <input type="text" id="lastName" class="form-control" th:value="${user.lastName}">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Số điện thoại</label>
                    <input type="text" id="phone" class="form-control" th:value="${user.phone}">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Ngày sinh</label>
                    <input type="date" id="birthDate" class="form-control" th:value="${user.birthDate}">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Giới tính</label>
                    <select id="gender" class="form-select">
                        <option value="">Chọn giới tính</option>
                        <option value="NAM" th:selected="${user.gender == 'NAM'}">Nam</option>
                        <option value="NU" th:selected="${user.gender == 'NU'}">Nữ</option>
                        <option value="KHAC" th:selected="${user.gender == 'KHAC'}">Khác</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Địa chỉ</label>
                    <input type="text" id="address" class="form-control" th:value="${user.address}">
                </div>

                <div class="col-12">
                    <label class="form-label">Mô tả bản thân</label>
                    <textarea id="profileInfo" class="form-control" rows="2" th:text="${user.profileInfo}"></textarea>
                </div>

                <div class="col-12">
                    <label class="form-label">Bio (giới thiệu ngắn)</label>
                    <textarea id="bio" class="form-control" rows="2" th:text="${user.userProfile?.bio}"></textarea>
                </div>

                <div class="col-12">
                    <label class="form-label">Liên kết trang cá nhân</label>
                    <input type="text" class="form-control" th:value="@{'/profile/' + ${user.username}}" readonly style="background:#f2f4f8;">
                    <div class="mt-1">
                        <a th:href="@{'/profile/' + ${user.username}}" target="_blank" class="small text-primary">
                            Xem trang cá nhân
                        </a>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-4">
                <a th:href="@{'/profile/' + ${user.username}}" class="btn btn-outline-secondary">Hủy</a>
                <button type="button" class="btn btn-outline-warning" onclick="resetForm()">Đặt lại</button>
                <button type="button" class="btn btn-warning fw-bold" onclick="updateProfile()">
                    <i class="fa fa-save me-1"></i>Lưu thay đổi
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/jwt-utils.js"></script>
<script src="/js/logout.js"></script>

<script>
    const cloudName = "dsqkymrkm";

    // Sử dụng preset riêng cho từng loại
    const uploadPresets = {
        avatar: "forumikaa-avatar",
        cover: "forumikaa-cover"
    };

    // Upload function với preset riêng
    function uploadToCloudinary(file, folder, callback) {
        const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPresets[folder]);

        fetch(url, {
            method: "POST",
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.secure_url) {
                    callback(data.secure_url);
                } else {
                    throw new Error(data.error?.message || "Upload failed");
                }
            })
            .catch(err => {
                console.error("Upload error:", err);
                alert("Lỗi upload ảnh: " + err.message);
            });
    }

    // Avatar upload
    document.getElementById("avatarInput").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert("Vui lòng chọn file ảnh");
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert("File ảnh không được vượt quá 5MB");
                return;
            }

            uploadToCloudinary(file, "avatar", function (url) {
                document.getElementById("avatarPreview").src = url;
                document.getElementById("avatarUrlInput").value = url;
            });
        }
    });

    // Cover upload
    document.getElementById("coverInput").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert("Vui lòng chọn file ảnh");
                return;
            }

            // Validate file size (max 10MB for cover)
            if (file.size > 10 * 1024 * 1024) {
                alert("File ảnh cover không được vượt quá 10MB");
                return;
            }

            uploadToCloudinary(file, "cover", function (url) {
                document.getElementById("coverPreview").src = url;
                document.getElementById("coverUrlInput").value = url;
            });
        }
    });


    function resetCoverDefault() {
        const defaultUrl = 'https://media.vietnamplus.vn/images/ff19e4aafab8485e8307470102cc768913111b4eeeb06dd8393e71d67982f6bf02764b1fba7ad23425af24c332b1cd09/dai-hoc-phenikaa.jpg';
        document.getElementById('coverPreview').src = defaultUrl;
        document.getElementById('coverInput').value = '';
        document.getElementById('coverUrlInput').value = defaultUrl;
    }

    // Function to update profile via AJAX
    function updateProfile() {
        const submitBtn = document.querySelector('button[onclick="updateProfile()"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i>Đang lưu...';
        submitBtn.disabled = true;

        // Collect form data
        const formData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            birthDate: document.getElementById('birthDate').value,
            gender: document.getElementById('gender').value,
            profileInfo: document.getElementById('profileInfo').value,
            bio: document.getElementById('bio').value,
            avatar: document.getElementById('avatarUrlInput').value,
            cover: document.getElementById('coverUrlInput').value
        };

        // Send AJAX request using authenticatedFetch
        authenticatedFetch('/api/profile/update', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (response.ok) {
                return response.text();
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .then(data => {
            // Success
            if (window.toastManager) {
                window.toastManager.show('Cập nhật profile thành công!', 'success');
            } else {
                showToast('success', 'Cập nhật profile thành công!');
            }
            setTimeout(() => {
                window.location.href = '/profile/' + document.getElementById('username').value;
            }, 1500);
        })
        .catch(error => {
            console.error('Error:', error);
            if (window.toastManager) {
                window.toastManager.show('Có lỗi xảy ra khi cập nhật profile: ' + error.message, 'error');
            } else {
                showToast('error', 'Có lỗi xảy ra khi cập nhật profile: ' + error.message);
            }
        })
        .finally(() => {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }

    // Function to reset form
    function resetForm() {
        document.getElementById('profileForm').reset();
        // Reset avatar and cover to original values
        const originalAvatar = document.getElementById('avatarUrlInput').getAttribute('th:value');
        const originalCover = document.getElementById('coverUrlInput').getAttribute('th:value');
        if (originalAvatar) {
            document.getElementById('avatarPreview').src = originalAvatar;
            document.getElementById('avatarUrlInput').value = originalAvatar;
        }
        if (originalCover) {
            document.getElementById('coverPreview').src = originalCover;
            document.getElementById('coverUrlInput').value = originalCover;
        }
    }

    // Function to show toast notifications
    function showToast(type, message) {
        // Create toast element
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fa fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        // Add to toast container
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Show toast
        const toastElement = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Remove toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }
</script>


</body>
</html> 