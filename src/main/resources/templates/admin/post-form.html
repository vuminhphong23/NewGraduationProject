<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh sửa bài viết - Forumikaa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/admin/layout.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div th:replace="~{fragments/admin/sidebar :: sidebar}"></div>

        <!-- Main Content -->
        <main class="col-md-10 ms-sm-auto px-md-4 py-4">
            <!-- Header -->
             <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold mb-0">Chỉnh sửa bài viết</h2>
                <a th:href="@{/admin/posts}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Quay lại danh sách
                </a>
            </div>

            <div class="bg-white rounded-3 p-4 shadow-sm">
                <form th:action="@{/admin/posts/save}" th:object="${post}" method="post">
                    <input type="hidden" th:field="*{id}" />

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="title" class="form-label">Tiêu đề bài viết</label>
                            <input type="text" class="form-control" id="title" th:field="*{title}" required>
                            <span th:if="${#fields.hasErrors('title')}" class="text-danger small" th:errors="*{title}"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="status" class="form-label">Trạng thái</label>
                            <select class="form-select" id="status" th:field="*{status}">
                                <option th:each="status : ${allStatuses}" 
                                        th:value="${status}" 
                                        th:text="${statusTextMap[status]}">
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="privacy" class="form-label">Quyền riêng tư</label>
                            <select class="form-select" id="privacy" th:field="*{privacy}">
                                <option th:each="privacy : ${allPrivacies}" 
                                        th:value="${privacy}" 
                                        th:text="${privacyTextMap[privacy]}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tác giả</label>
                            <div class="d-flex align-items-center">
                                <img th:src="${post.user.userProfile?.avatar != null ? post.user.userProfile.avatar : 'https://i.pravatar.cc/36?u=' + post.user.id}" 
                                     class="table-avatar me-2" alt="avatar">
                                <div>
                                    <div th:text="${post.user.username}" class="fw-bold"></div>
                                    <div th:text="${post.user.firstName + ' ' + post.user.lastName}" class="text-muted small"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">Nội dung bài viết</label>
                        <textarea class="form-control" id="content" th:field="*{content}" rows="10" required></textarea>
                        <span th:if="${#fields.hasErrors('content')}" class="text-danger small" th:errors="*{content}"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Chủ đề (Topics)</label>
                        <div class="border rounded p-3" style="min-height: 60px;">
                            <div th:if="${post.topics != null and !post.topics.isEmpty()}">
                                <span th:each="topic : ${post.topics}" 
                                      class="badge bg-primary me-2 mb-2">
                                    #<span th:text="${topic.name}"></span>
                                </span>
                            </div>
                            <div th:if="${post.topics == null or post.topics.isEmpty()}" class="text-muted">
                                Chưa có chủ đề nào
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Thống kê tương tác</label>
                            <div class="d-flex flex-column">
                                <div class="d-flex justify-content-between">
                                    <span><i class="bi bi-heart text-danger"></i> Lượt thích:</span>
                                    <span th:text="${post.likeCount}">0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span><i class="bi bi-chat text-primary"></i> Bình luận:</span>
                                    <span th:text="${post.commentCount}">0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span><i class="bi bi-share text-success"></i> Chia sẻ:</span>
                                    <span th:text="${post.shareCount}">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Thông tin thời gian</label>
                            <div class="d-flex flex-column">
                                <div class="d-flex justify-content-between">
                                    <span>Ngày tạo:</span>
                                    <span th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                </div>
                                <div class="d-flex justify-content-between" th:if="${post.updatedAt != null}">
                                    <span>Cập nhật:</span>
                                    <span th:text="${#temporals.format(post.updatedAt, 'dd/MM/yyyy HH:mm')}"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tài liệu đính kèm</label>
                            <div th:if="${post.documents != null and !post.documents.isEmpty()}">
                                <div th:each="doc : ${post.documents}" class="small mb-1">
                                    <i class="bi bi-paperclip"></i>
                                    <span th:text="${doc.originalName}"></span>
                                    <span class="text-muted" th:text="'(' + ${doc.fileSize} + ' bytes)'"></span>
                                </div>
                            </div>
                            <div th:if="${post.documents == null or post.documents.isEmpty()}" class="text-muted small">
                                Không có tài liệu đính kèm
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Lưu thay đổi
                        </button>
                        <a th:href="@{/admin/posts}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Hủy
                        </a>
                    </div>
                </form>
            </div>
        </main>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/jwt-utils.js"></script>
<script src="/js/logout.js"></script>
</body>
</html>
